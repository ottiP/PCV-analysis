---
title: "PCV_analysis -- Dataset 1 and 2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load required R packages
```{r}
library(table1)
library(dplyr)
library(ggplot2)
#library(GGally)
library(car)
source('./R/functions.R')
```

```{r}
### Load the data: 
core_table <- read.csv("./Data/core_table_filled.csv")
core_table_norace <- read.csv("./Data/core_table_droprace_filled.csv")
```

## Check that individuals are the same across dataframes
```{r}
print(paste0("Total number of individuals: "))
sum(core_table$count)
print("\n")
sum(core_table_norace$count)
```
## Define covariates
```{r}
list_cov <- c("year_month","age","patient_gender_code","race_code","PCV_combined")
```


## Run the first logistic regression analysis looking at outcome: severe respiratory outcome for Covid-19 versus non-severe outcomes
```{r}
list_out <- c("non_severe","resp_severe")
m1<-run_model(core_table,list_cov,list_out)
View(m1$m.table)
```
## Check collinearity among the covariates using variance inflation factor (VIF): VIF answers the question: "How well is one of my covariates x_i explained by all other covariates x jointly?".
The VIF is defined as 1/(1-R_squared); this means that for VIF>=10, this specific covariate is explained by all other covariates to a large extent (~90%). There could be a problem of collinearity.
```{r}
m1$vif
```
## Second part of the analysis: restrict to people with severe non-respiratory vs non-severe outcomes for Covid-19
```{r}
list_out <- c("non_severe","non_resp_severe")
m2<-run_model(core_table,list_cov,list_out)
View(m2$m.table)
```
##Check collinearity
```{r}
m2$vif
```

## Third part of the analysis: restrict to people with ICU critical care vs non-severe outcomes for Covid-19
```{r}
list_out <- c("non_severe","ICU_crit_care")
m3<-run_model(core_table,list_cov,list_out)
View(m3$m.table)
```

##Check collinearity
```{r}
m3$vif
```

## Fourth part of the analysis: restrict to people with ICU critical care vs respiratory severe outcomes for Covid-19

```{r}
list_out <- c("ICU_crit_care","resp_severe")
m4<-run_model(core_table,list_cov,list_out)
View(m4$m.table)
```

##Check collinearity
```{r}
m4$vif
```


